# Coolify Deployment Guide

This guide explains how to deploy the Efata Financials application to Coolify.

## Prerequisites

- A Coolify instance set up and running
- Access to your Coolify dashboard
- Git repository connected to your project

## Deployment Steps

### 1. Install the Node Adapter

Before deploying, install the SvelteKit Node adapter:

```bash
npm install
```

### 2. Add to Coolify

1. Log in to your Coolify dashboard
2. Click "New Resource" â†’ "Application"
3. Select your Git repository
4. Configure the following settings:

#### Build Settings

- **Build Pack**: Dockerfile
- **Dockerfile Location**: `./Dockerfile`

#### Port Configuration

- **Port**: `3000`

#### Environment Variables

Set the following environment variables in Coolify:

```
NODE_ENV=production
PORT=3000
HOST=0.0.0.0
AUTH_URL=https://your-domain.com

# Authentication (REQUIRED)
AUTH_SECRET=<generate-with-openssl-rand-base64-32>
GOOGLE_CLIENT_ID=<your-google-client-id>
GOOGLE_CLIENT_SECRET=<your-google-client-secret>
```

**Important**: Before deployment, you MUST:
1. Set up Google OAuth credentials (see AUTH_SETUP.md)
2. Generate a secure AUTH_SECRET: `openssl rand -base64 32`
3. Add your production domain to Google OAuth authorized URIs

#### Google OAuth Settings (Production)

In Google Cloud Console for your OAuth client, set:

- **Authorized JavaScript origins**
  - `https://your-domain.com`
- **Authorized redirect URIs**
  - `https://your-domain.com/auth/callback/google`

If your Coolify app uses an autogenerated domain first, add that domain too, then switch to your final custom domain and keep both until cutover is complete.

### 3. Persistent Storage (Important for Database)

Your application uses SQLite, so you need to configure persistent storage:

1. In Coolify, go to your application's "Storage" tab
2. Add a new volume:
   - **Source**: Create a new volume (e.g., `efata-db-data`)
   - **Destination**: `/app/data`
   - This will persist your SQLite database across deployments

### 4. Database Setup

After first deployment:

1. Connect to your container via Coolify's terminal
2. Set up your database:
   ```bash
   node scripts/seed-finance-dummy.mjs
   ```

Or you can add this to a startup script if needed.

### 5. Health Checks

Configure health checks in Coolify:
- **Health Check Path**: `/` (or create a `/health` endpoint)
- **Health Check Port**: `3000`

## Testing Locally with Docker

Before deploying to Coolify, you can test the Docker build locally:

```bash
# Build the image
docker build -t efata-financials .

# Run the container
docker run -p 3000:3000 -v $(pwd)/data:/app/data efata-financials
```

Or use docker-compose:

```bash
docker-compose up
```

## Troubleshooting

### Database Issues

If the database is not persisting:
- Ensure the volume mount is correctly configured in Coolify
- Check that `/app/data` directory has write permissions

### Build Failures

If the build fails:
- Check that all dependencies are listed in `package.json`
- Verify that `@sveltejs/adapter-node` is installed
- Review build logs in Coolify

### Port Issues

If the application isn't accessible:
- Ensure PORT is set to `3000` in environment variables
- Verify the port mapping in Coolify matches the exposed port

## Additional Configuration

### Custom Domain

1. Go to your application in Coolify
2. Navigate to "Domains"
3. Add your custom domain
4. Configure DNS records as shown by Coolify

### SSL/HTTPS

Coolify automatically handles SSL certificates via Let's Encrypt if you've configured a custom domain.

## Updating the Application

Coolify can auto-deploy on git push:
1. Enable "Automatic Deployment" in Coolify
2. Set the branch to watch (e.g., `main`)
3. Push changes to trigger deployment

## File Upload Considerations

Your application handles file uploads (transfer proofs). For production:
- Consider using persistent storage for `/app/data/proofs`
- Or migrate to object storage (S3, MinIO, etc.) for better scalability

## Backup

To backup your database:
1. Access the Coolify terminal
2. Copy the database file:
   ```bash
   cp /app/data/efata.db /tmp/backup-$(date +%Y%m%d).db
   ```
3. Download via Coolify's file manager or use `docker cp`

## Support

For Coolify-specific issues, refer to:
- [Coolify Documentation](https://coolify.io/docs)
- [Coolify Discord](https://discord.gg/coolify)
